name: Executar Cypress - Teste Alterado

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      # Passo 1: Baixar o código
      - name: Checkout do código
        uses: actions/checkout@v3

      # Passo 2: Configurar Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      # Passo 3: Instalar dependências
      - name: Instalar dependências
        run: npm ci

      # Passo 4: Identificar arquivo de teste alterado
      - name: Detectar arquivo Cypress alterado
        id: detect-changes
        run: |
          git fetch origin main
          git diff --name-only origin/main > changed-files.txt
          grep -E 'cypress/e2e/.*\.cy\.js' changed-files.txt > tests-to-run.txt || true
          if [ -s tests-to-run.txt ]; then
            echo "::set-output name=test_file::$(head -n 1 tests-to-run.txt)"
          fi

      # Passo 5: Executar teste alterado
      - name: Executar Cypress no arquivo alterado
        if: steps.detect-changes.outputs.test_file != ''
        run: |
          npx cypress run --spec ${{ steps.detect-changes.outputs.test_file }}